<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Block World</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #87ceeb; font-family: ui-sans-serif, system-ui, sans-serif; }
        #game-container { position: relative; width: 100vw; height: 100vh; }
        canvas { display: block; width: 100%; height: 100%; touch-action: none; }
        .ui-panel { pointer-events: none; }
        .ui-panel * { pointer-events: auto; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <!-- UI Overlay -->
    <div class="absolute inset-0 ui-panel flex flex-col justify-between p-4">
        <div class="flex justify-between items-start">
            <div class="bg-white/80 backdrop-blur-sm p-3 rounded-xl shadow-sm border border-white/20">
                <h1 class="text-lg font-bold text-slate-800 leading-none">Block World</h1>
                <div id="player-count" class="text-[10px] text-slate-500 font-bold uppercase mt-1">1 Player Online</div>
            </div>
            
            <div id="status" class="bg-white/80 px-3 py-1 rounded-full text-[10px] font-bold text-slate-600 shadow-sm border border-white/20">
                Connecting...
            </div>
        </div>

        <!-- Minimal Chat -->
        <div class="w-64">
            <div id="chat-messages" class="h-24 overflow-y-auto p-2 space-y-1 text-[11px] font-medium drop-shadow-sm">
                <!-- Messages appear here -->
            </div>
            <form id="chat-form" class="flex gap-1 mt-1">
                <input type="text" id="chat-input" maxlength="50" placeholder="Say hi..." class="flex-1 bg-white/90 backdrop-blur-sm rounded-full px-3 py-1 text-xs text-slate-800 outline-none shadow-sm focus:ring-2 focus:ring-blue-400 border border-white/50">
                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center transition-all shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></svg>
                </button>
            </form>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Configuration & Initialization ---
    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'simple-blocks-v1';

    const CANVAS = document.getElementById('gameCanvas');
    const CTX = CANVAS.getContext('2d');
    const PLAYER_SIZE = 36;
    const SPEED = 5;
    const JUMP_FORCE = -14;
    const GRAVITY = 0.7;
    const WORLD_SIZE = { width: 3000, height: 800 };

    let me = {
        id: null,
        x: Math.random() * (WORLD_SIZE.width - PLAYER_SIZE),
        y: WORLD_SIZE.height - PLAYER_SIZE,
        vy: 0,
        isGrounded: false,
        color: `hsl(${Math.random() * 360}, 80%, 65%)`,
        name: `User_${Math.floor(Math.random() * 999)}`,
        lastUpdate: Date.now()
    };

    let players = {};
    let messages = [];
    const keys = {};
    let isInitialized = false;

    async function init() {
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                document.getElementById('status').innerText = "OFFLINE";
            }
        };

        await initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user && !isInitialized) {
                me.id = user.uid;
                isInitialized = true;
                document.getElementById('status').innerText = "ONLINE";
                setupSync();
            }
        });
    }

    function setupSync() {
        if (!me.id) return;
        
        // Use strict paths as per environment rules
        const playersRef = collection(db, 'artifacts', appId, 'public', 'data', 'players');
        const chatRef = collection(db, 'artifacts', appId, 'public', 'data', 'chat');

        // Guard every Firestore operation with auth check
        const playerUnsubscribe = onSnapshot(playersRef, (snapshot) => {
            if (!auth.currentUser) return;
            const newPlayers = {};
            snapshot.forEach(doc => {
                const data = doc.data();
                if (Date.now() - data.lastUpdate < 10000) newPlayers[doc.id] = data;
            });
            players = newPlayers;
            document.getElementById('player-count').innerText = `${Object.keys(players).length} ${Object.keys(players).length === 1 ? 'Player' : 'Players'} Online`;
        }, (error) => console.error("Player sync error:", error));

        const chatUnsubscribe = onSnapshot(chatRef, (snapshot) => {
            if (!auth.currentUser) return;
            const msgs = [];
            snapshot.forEach(doc => msgs.push(doc.data()));
            // Sort in memory as per rule 2
            msgs.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
            messages = msgs.slice(-10);
            renderChat();
        }, (error) => console.error("Chat sync error:", error));

        setInterval(async () => {
            if (!auth.currentUser || !me.id) return;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', me.id), { 
                    ...me, 
                    lastUpdate: Date.now() 
                }, { merge: true });
            } catch (e) {
                console.error("Heartbeat error:", e);
            }
        }, 500); // Reduced frequency slightly to be safer
    }

    async function sendChatMessage(text) {
        if (!auth.currentUser || !me.id || !text.trim()) return;
        try {
            const chatRef = collection(db, 'artifacts', appId, 'public', 'data', 'chat');
            await setDoc(doc(chatRef), { 
                sender: me.name, 
                text, 
                color: me.color, 
                timestamp: serverTimestamp() 
            });
        } catch (e) {
            console.error("Send message error:", e);
        }
    }

    function handlePhysics() {
        if (keys['a'] || keys['arrowleft']) me.x -= SPEED;
        if (keys['d'] || keys['arrowright']) me.x += SPEED;
        me.vy += GRAVITY;
        me.y += me.vy;
        if (me.y > WORLD_SIZE.height - PLAYER_SIZE) {
            me.y = WORLD_SIZE.height - PLAYER_SIZE;
            me.vy = 0;
            me.isGrounded = true;
        } else {
            me.isGrounded = false;
        }
        if ((keys['w'] || keys['arrowup'] || keys[' ']) && me.isGrounded) {
            me.vy = JUMP_FORCE;
            me.isGrounded = false;
        }
        me.x = Math.max(0, Math.min(WORLD_SIZE.width - PLAYER_SIZE, me.x));
    }

    function draw() {
        if (CANVAS.width !== window.innerWidth || CANVAS.height !== window.innerHeight) {
            CANVAS.width = window.innerWidth;
            CANVAS.height = window.innerHeight;
        }
        handlePhysics();
        CTX.clearRect(0, 0, CANVAS.width, CANVAS.height);

        const camX = me.x - CANVAS.width / 2 + PLAYER_SIZE / 2;
        const camY = me.y - CANVAS.height / 2 + PLAYER_SIZE / 2;

        CTX.save();
        CTX.translate(-camX, -camY);

        // Sky background
        CTX.fillStyle = 'rgba(255,255,255,0.4)';
        for(let i=0; i<10; i++) {
            CTX.beginPath();
            CTX.arc(i*400 + 100, 200, 40, 0, Math.PI*2);
            CTX.arc(i*400 + 140, 200, 50, 0, Math.PI*2);
            CTX.arc(i*400 + 180, 200, 40, 0, Math.PI*2);
            CTX.fill();
        }

        // Grass Floor
        CTX.fillStyle = '#4ade80';
        CTX.fillRect(0, WORLD_SIZE.height, WORLD_SIZE.width, 2000);
        
        // Dirt under grass
        CTX.fillStyle = '#92400e';
        CTX.fillRect(0, WORLD_SIZE.height + 15, WORLD_SIZE.width, 2000);

        // Players
        Object.entries(players).forEach(([id, p]) => {
            if (id === me.id) return;
            drawBlock(p);
        });
        drawBlock(me, true);

        CTX.restore();
        requestAnimationFrame(draw);
    }

    function drawBlock(p, isLocal = false) {
        CTX.fillStyle = p.color;
        CTX.beginPath();
        CTX.roundRect(p.x, p.y, PLAYER_SIZE, PLAYER_SIZE, 8);
        CTX.fill();
        
        CTX.fillStyle = '#0f172a';
        const squint = p.vy < -2 ? 2 : 0;
        CTX.fillRect(p.x + 8, p.y + 12 + squint, 6, 6 - squint);
        CTX.fillRect(p.x + 22, p.y + 12 + squint, 6, 6 - squint);

        CTX.fillStyle = isLocal ? '#1e293b' : 'white';
        CTX.font = 'bold 9px sans-serif';
        CTX.textAlign = 'center';
        CTX.fillText(isLocal ? "YOU" : p.name.toUpperCase(), p.x + PLAYER_SIZE/2, p.y - 10);
    }

    function renderChat() {
        const container = document.getElementById('chat-messages');
        container.innerHTML = messages.map(m => `
            <div class="bg-white/40 backdrop-blur-sm px-2 py-1 rounded-lg w-fit max-w-full">
                <span style="color: ${m.color}" class="font-black text-[9px] uppercase">${m.sender}:</span>
                <span class="text-slate-800">${m.text}</span>
            </div>
        `).join('');
        container.scrollTop = container.scrollHeight;
    }

    window.addEventListener('keydown', e => {
        const k = e.key.toLowerCase();
        keys[k] = true;
        if([" ", "arrowup", "arrowleft", "arrowright"].includes(k) && document.activeElement !== document.getElementById('chat-input')) e.preventDefault();
    });
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

    document.getElementById('chat-form').onsubmit = (e) => {
        e.preventDefault();
        const input = document.getElementById('chat-input');
        if (input.value) {
            sendChatMessage(input.value);
            input.value = '';
            input.blur();
        }
    };

    init();
    draw();
</script>
</body>
</html>
